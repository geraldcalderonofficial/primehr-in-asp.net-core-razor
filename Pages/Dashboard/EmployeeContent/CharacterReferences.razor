@using HRMSv4.Client.Shared.Modals
@using HRMSv4.Client.Shared.Modals.EmployeeModals
@inject ICharacterReference service
@inject SweetAlertService Swal;
@using static HRMSv4.Shared.OnBoarding.CharacterReference
@using DevExpress.Blazor

<BusyIndicator Message="Please wait while loading data..." Data="charRefListView">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="col-12 mt-2">
                        <h5 class="card-header-text float-start">Character Reference</h5>
                        <button class="mb-2 me-2 btn btn-outline-2x btn-outline-primary float-end" onclick="@InsertRow" style="margin-bottom: 10px; width:200px"> + Add </button>

                        @*<RadzenButton Icon="add_circle_outline" class="btn-info float-end" style="margin-bottom: 10px" Text="Add" Click="@InsertRow" />*@
                    </div>
                </div>
                <div class="card-block">
                    <!-- Educataional Tab -->
                    <div class="col-12 p-2">
                        <div class="card">
                            <DxGrid Data="@CrList" PageSize="20"
                                    ShowFilterRow="true"
                                    PagerPosition="GridPagerPosition.Bottom"
                                    PageSizeSelectorVisible="true"
                                    PageSizeSelectorItems="@(new int[] { 5, 10, 20, 100 })"
                                    PageSizeSelectorAllRowsItemVisible="true"
                                    PagerSwitchToInputBoxButtonCount="10"
                                    PagerVisibleNumericButtonCount="10">

                                <Columns>
                                    <DxGridDataColumn FieldName="Fullname" />
                                    <DxGridDataColumn FieldName="Address" />
                                    <DxGridDataColumn FieldName="ContactNumber" />
                                    <DxGridDataColumn FieldName="" Caption="Action" AllowSort="false" Width="90px" MinWidth="100" TextAlignment="GridTextAlignment.Center">
                                        <CellDisplayTemplate>
                                            @{
                                                var temp = (context.DataItem as CharacterReferenceListView);
                                            }
                                            <button class="border-0 btn-transition btn btn-outline-success" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit" data-bs-original-title="Edit" @onclick="(() => EditRow(temp))">
                                                <i class="fas fa-pen"></i>
                                            </button>
                                            <button class="border-0 btn-transition btn btn-outline-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete" data-bs-original-title="Delete" @onclick="(() => DeleteRow(temp))">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </CellDisplayTemplate>
                                    </DxGridDataColumn>
                                </Columns>
                            </DxGrid>
                         
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</BusyIndicator>
@code {
    [CascadingParameter] public IModalService Modal { get; set; }
    [Parameter]
    public int employeeId { get; set; }

    [Parameter]
    public bool isLoaded { get; set; }

    IEnumerable<CharacterReferenceListView> charRefListView;
    //RadzenDataGrid<CharacterReferenceListView> crGrid;

    string userId = "";
    object CrList { get; set; }
    GridDevExtremeDataSource<CharacterReferenceListView> gridDevExtremeDataSource;

    protected override async Task OnInitializedAsync()
    {
        charRefListView = null;
        var user = (await _AutService.GetAuthenticationStateAsync()).User;
        userId = user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;
        await UpdateDataAsync();
    }

    async Task UpdateDataAsync()
    {
        charRefListView = await service.GetAll(employeeId);

        var tempList = charRefListView.AsQueryable();

        gridDevExtremeDataSource = new GridDevExtremeDataSource<CharacterReferenceListView>(tempList);
        gridDevExtremeDataSource.CustomizeLoadOptions = (loadOptions) =>
        {
            loadOptions.PrimaryKey = new[] { "CharacterReferenceId" };
            loadOptions.PaginateViaPrimaryKey = true;

        };

        CrList = gridDevExtremeDataSource;


        StateHasChanged();
    }

    //protected override async Task OnParametersSetAsync()
    //{
    //    if (employeeId > 0)
    //    {
    //        await Task.Delay(1000); // simulate loading
    //        charRefListView = await service.GetAll(employeeId);
    //        this.StateHasChanged();
    //    }
    //}

    async Task InsertRow()
    {
        var parameters = new ModalParameters();
        parameters.Add(nameof(CharacterReferenceModal.employeeId), employeeId);

        var options = new ModalOptions()
            {
                DisableBackgroundCancel = true
            };

        var _modalStatus = Modal.Show<CharacterReferenceModal>("New Character Reference", parameters, options);
        var modalResult = await _modalStatus.Result;
        if (!modalResult.Cancelled)
        {
            await UpdateDataAsync();
            this.StateHasChanged();
        }
    }

    async Task EditRow(CharacterReferenceListView cr)
    {
        SweetAlertResult result = await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Confirm",
                Text = "Would you like to edit selected record?",
                Icon = "question",
                AllowOutsideClick = false,
                ShowCancelButton = true,
                ConfirmButtonText = "Yes",
                CancelButtonText = "Cancel",
                CancelButtonColor = "#dc3741"

            });

        if (!string.IsNullOrEmpty(result.Value))
        {
            var parameters = new ModalParameters();
            parameters.Add(nameof(CharacterReferenceModal.CharacterReferenceId), cr.CharacterReferenceId);
            var _modalStatus = Modal.Show<CharacterReferenceModal>("Edit Character Reference", parameters);
            var modalResult = await _modalStatus.Result;
            if (modalResult.Cancelled == false)
            {
                await UpdateDataAsync();
                this.StateHasChanged();
            }
        }
        else
        {
            await Swal.FireAsync("Wew!", "Your record is safe.", "success");
        }
    }

    async Task DeleteRow(CharacterReferenceListView cr)
    {
        SweetAlertResult result = await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Are you sure?",
                Text = "You are about to delete this record.",
                Icon = "warning",
                ShowCancelButton = true,
                AllowOutsideClick = false,
                ConfirmButtonText = "Yes, delete it!",
                CancelButtonText = "Cancel",
                CancelButtonColor = "#dc3741"

            });

        if (!string.IsNullOrEmpty(result.Value))
        {
            var httRes = await service.Delete(cr.CharacterReferenceId);

            if (httRes.IsSuccessStatusCode)
            {
                await UpdateDataAsync();
                StateHasChanged();
                string resMsg = await httRes.Content.ReadAsStringAsync();
                await Swal.FireAsync("Success", "A record was successfully deleted.", "success");
            }
            else
            {
                await Swal.FireAsync("Oops...", "Something went wrong!", "error");
            }
        }
        else
        {
            await Swal.FireAsync("Wew!", "Your record is safe.", "success");
        }
    }
}
