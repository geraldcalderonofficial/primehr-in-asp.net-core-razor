@page "/masterdata/clusters"
@using DevExpress.Blazor
@using HRMSv4.Shared.Payroll
@using HRMSv4.Client.Interface.Payroll
@inject IStaffing serviceStaffing
@inject IJSRuntime JSRuntime
@inject IPosition service
@inject IPayrollClusters clusterService
@inject SweetAlertService _swal


<div class="app-page-title">
    <div class="page-title-wrapper">
        <div class="page-title-heading">
            <h3>
                Payroll Clusters
            </h3>
        </div>
        <div class="page-title-actions">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/module-deductions">Payroll Profiles</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Payroll Clusters</li>
                </ol>
            </nav>
        </div>
    </div>
</div>

<div class="col-sm-12 col-xl-12 col-md-12 main-card mb-3 card">
    <div class="card-body" onbeforeunload="TestDataTablesRemove('#example')">
        <div class="col-lg-16" align="right">
            <button class="mb-2 me-2 btn btn-outline-2x btn-outline-primary" style="margin-bottom: 10px; width:200px" onclick="@InsertRow"> Add </button>
        </div>
        <DxGrid @ref="MyGrid" Data="clusters"
                ValidationEnabled="false"
                PopupEditFormCssClass="pw-800"
                EditMode="GridEditMode.EditRow"
                PagerVisible="true"
                PageSize="5"
                ShowFilterRow="true">
            <Columns>
                <DxGridDataColumn Width="20rem" FieldName="ClusterName" Caption="Cluster Name">
                </DxGridDataColumn>
                <DxGridDataColumn FieldName="FundingAgency" Caption="Funding Agency">
                </DxGridDataColumn>
                <DxGridDataColumn Width="20rem" FieldName="PayrollClusterId" Caption="Action" AllowSort="false" TextAlignment="GridTextAlignment.Center">
                    <CellDisplayTemplate>
                        @{
                            var temp = (context.DataItem as HRMSv4.Shared.Payroll.PayrollCluster);
                        }
                        <button data-bs-toggle="tooltip" data-bs-placement="left" title="" data-bs-original-title="Edit" class="border-0 btn-transition btn btn-outline-success" @onclick="()=> EditRow(temp)"><span class="pe-7s-note"></span></button>
                        <button data-bs-toggle="tooltip" data-bs-placement="left" title="" data-bs-original-title="Delete" class="border-0 btn-transition btn btn-outline-danger" @onclick="()=> DeleteRow((int)context.Value)"><span class="pe-7s-trash"></span></button>
                        <button data-bs-toggle="tooltip" data-bs-placement="left" title="" data-bs-original-title="Members" class="border-0 btn-transition btn btn-outline-primary" @onclick="()=> ManageMembers((int)context.Value)"><span class="pe-7s-user"></span></button>
                    </CellDisplayTemplate>
                </DxGridDataColumn>
            </Columns>
        </DxGrid>
    </div>
</div>

@code {

    IGrid? MyGrid { get; set; }
    [CascadingParameter] public IModalService Modal { get; set; }
    IEnumerable<PayrollCluster> clusters = new List<PayrollCluster>();

    protected override async Task OnInitializedAsync()
    {
        clusters = await clusterService.GetClusters();
        this.StateHasChanged();
    }

    async Task InsertRow()
    {
        var _modalStatus = Modal.Show<HRMSv4.Client.Shared.Modals.Masterdata.Cluster.ClusterModal>("Add Payroll Cluster");
        var modalResult = await _modalStatus.Result;
        if (!modalResult.Cancelled)
        {
            clusters = await clusterService.GetClusters();
            this.StateHasChanged();
        }
    }

    async Task EditRow(PayrollCluster pc)
    {
        var parameters = new ModalParameters();
        parameters.Add(nameof(HRMSv4.Client.Shared.Modals.Masterdata.Cluster.ClusterModal._cluster), pc);

        var options = new ModalOptions()
            {
                DisableBackgroundCancel = true,
                Animation = ModalAnimation.FadeIn(0.2),

            };

        var _modalStatus = Modal.Show<HRMSv4.Client.Shared.Modals.Masterdata.Cluster.ClusterModal>("Edit Payroll Cluster", parameters, options);
        var modalResult = await _modalStatus.Result;
        if (!modalResult.Cancelled)
        {
            clusters = await clusterService.GetClusters();
            this.StateHasChanged();
        }
    }

    async Task DeleteRow(int id)
    {
        try
        {
            SweetAlertResult res = await _swal.FireAsync(new SweetAlertOptions
                {
                    Title = "Are you sure?",
                    Text = "You will not be able to recover this record!",
                    Icon = "warning",
                    ShowCancelButton = true,
                    ConfirmButtonText = "Yes, delete it!",
                    CancelButtonText = "No, keep it",
                    CancelButtonColor = "red"
                });

            if (!string.IsNullOrEmpty(res.Value))
            {
                var result = await clusterService.DeleteCluster(id);

                if (result.StatusCode == 200)
                {

                    clusters = await clusterService.GetClusters();
                    StateHasChanged();

                    await _swal.FireAsync(
                                  "Deleted",
                                  "Record has been deleted.",
                                  "success"
                                  );
                }
                else
                {
                    await _swal.FireAsync(
                      "Oops...",
                      "Something went wrong.",
                      "error"
                      );
                }
            }
        }
        catch (Exception e)
        {

            throw e;
        }
    }

    async Task ManageMembers(int id)
    {
        try
        {
            var parameters = new ModalParameters();
            parameters.Add(nameof(HRMSv4.Client.Shared.Modals.Masterdata.Cluster.ClusterMembersModal.ClusterId), id);

            var options = new ModalOptions()
                {
                    DisableBackgroundCancel = true,
                    Animation = ModalAnimation.FadeIn(0.2),
                    ContentScrollable = true
                };


            var selectedCluster = await clusterService.GetaCluster(id);
            var _modalStatus = Modal.Show<HRMSv4.Client.Shared.Modals.Masterdata.Cluster.ClusterMembersModal>("Manage Clusters", parameters, options);
            var modalResult = await _modalStatus.Result;
            if (!modalResult.Cancelled)
            {
                clusters = await clusterService.GetClusters();
                this.StateHasChanged();
            }
        }
        catch (Exception e)
        {

            throw e;
        }
    }
}
